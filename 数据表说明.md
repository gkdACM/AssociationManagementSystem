# 数据表说明

以下为当前数据库各数据表的用途说明与关键关系简介。

- `alembic_version`
  - 迁移版本跟踪表，记录 Alembic 当前应用的数据库 schema 版本。

- `department`
  - 协会部门信息表；`name` 唯一。
  - 作为用户（`user.department_id`）、竞赛（`competition.department_id`）、考试（`exam.department_id`）、项目（`project.department_id`）的所属关系。

- `user`
  - 会员用户信息主表，含学号、姓名、班级、性别、年级、联系方式、密码哈希。
  - 权限相关：`role`（system_admin/president/vice_president/minister/member）、`registration_status`（pending/approved/rejected）、`is_active`。
  - 组织关系：`department_id` 指向 `department`。
  - 与多表关联：参与竞赛、考试、项目、资料变更、退会申请、积分流水等。

- `registration_audit`
  - 入会审核记录表，记录对用户注册的审批/驳回动作。
  - 字段示例：`user_id`、`action`（approve/reject）、`reason`、`operator_id`、`created_at`。

- `user_profile_history`
  - 资料变更申请与审批历史，记录一次申请的内容与审核结论。
  - 字段示例：`changes`（JSON，包含变更的键值对，如部门调整）、`status`（pending/approved/rejected）、`approver_id`、`reason`、`created_at/decided_at`。

- `leave_application`
  - 退会申请表，记录成员的退会原因与审批状态。
  - 字段示例：`user_id`、`reason`、`status`（pending/approved/rejected）、`operator_id`、`created_at/decided_at`。
  - 审批通过后，系统会禁用该用户并清空其部门归属。

- `exam`
  - 考试安排表（已由“竞赛”模块替换，保留用于历史数据）。
  - 字段示例：`title`、`description`、`department_id`、`exam_date`、`pass_threshold`、`created_at/updated_at`。

- `exam_result`
  - 考试成绩表，记录用户参加某场考试的成绩与是否通过。
  - 关键约束：唯一组合 `exam_id + user_id`（`uniq_exam_user`）。
  - 字段示例：`score`、`passed`、`remark`、`created_at/updated_at`。

- `competition`
  - 竞赛事件表，统一记录内部赛/外部赛及等级。
  - 字段示例：`name`、`description`、`category`（internal/external）、`level`（国际级/国家级/区域级/省级/市级/校级/联合赛/企业赛/邀请赛）、`department_id`、`event_date`、`created_at/updated_at`。

- `competition_result`
  - 竞赛成绩表，记录用户在某场竞赛中的得分/获奖情况。
  - 关键约束：唯一组合 `competition_id + user_id`（`uniq_competition_user`）。
  - 字段示例：`score`、`award`、`remark`、`created_at/updated_at`。

- `project`
  - 部门项目表，记录项目基础信息与生命周期状态。
  - 字段示例：`name`、`description`、`department_id`、`leader_user_id`（负责人）、`github_url`、`status`（draft/active/pending_acceptance/accepted/rejected）、`start_date/end_date`、`created_at/updated_at`。

- `project_participation`
  - 项目参与报名与审核表，记录成员对项目的报名及审批结果。
  - 关键约束：唯一组合 `project_id + user_id`（`uniq_project_user`）。
  - 字段示例：`status`（pending/approved/rejected）、`remark`、`applied_at/decided_at`。

- `level`
  - 积分等级定义表，配置等级名称及对应的积分阈值，用于将累计积分映射为等级徽标/称号。
  - 字段示例：`name`（唯一）、`threshold_points`、`description`、`created_at/updated_at`。

- `points_ledger`
  - 积分流水表，记录积分的来源与变动明细，用于统计累计积分。
  - 字段示例：`user_id`、`source_type`（exam/activity/manual）、`source_id`（来源标识，可为空）、`points`、`remark`、`created_at`。

——

关系总览（简要）：
- `user` ←→ `department`（多对一）
- `exam`/`competition`/`project` ←→ `department`（多对一）
- `exam_result`/`competition_result`/`project_participation`：均以（事件/项目 + 用户）形成唯一参与关系
- 审核与申请：`registration_audit`、`user_profile_history`、`leave_application` 以 `user_id` 建立与用户的业务关系
- 积分体系：`points_ledger` 产生积分流水，`level` 定义积分等级门槛
