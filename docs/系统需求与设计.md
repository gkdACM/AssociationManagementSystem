# 大学计算机协会会员管理系统 —— 需求与设计文档

## 1. 项目概述
本系统用于管理大学计算机协会的会员与部门，采用前后端不分离的 Flask 单体架构，配合 JWT 鉴权与 MySQL 数据库。

- 架构：Flask + Jinja2 模板 + SQLAlchemy（MySQL）
- 鉴权：JWT（优先采用 Cookie 模式，配合 CSRF 防护）
- 目标：支持会员注册、登录、个人资料维护；管理员管理部门与会员；基础统计与导出。

> 业务假设：每位会员属于一个部门；注册开放，管理员可审核/管理（审核流可后续按需增加）。

## 2. 技术栈与依赖
- Python：`>=3.10`
- Web 框架：`Flask`
- ORM：`SQLAlchemy` + 迁移：`Flask-Migrate`
- 表单与验证：`Flask-WTF`
- 密码哈希：`bcrypt`/`passlib`
- JWT：`Flask-JWT-Extended`
- MySQL 驱动：`PyMySQL`

## 3. 环境配置
- 必需环境变量：
  - `SECRET_KEY`：Flask 会话密钥
  - `JWT_SECRET_KEY`：JWT 密钥
  - `DATABASE_URL`：例如 `mysql+pymysql://user:pass@host:3306/association?charset=utf8mb4`
  - `FLASK_ENV`：`development`/`production`
- MySQL 建议配置：`utf8mb4` 字符集，`InnoDB` 引擎。

## 4. 项目结构（建议）
```
association/
  app/
    __init__.py
    models/
      __init__.py
      user.py
      department.py
    services/
      __init__.py
      auth_service.py
      user_service.py
      department_service.py
    views/
      __init__.py
      auth.py
      user.py
      admin.py
      department.py
    templates/
      layout.html
      auth/
        login.html
        register.html
      user/
        profile.html
      admin/
        dashboard.html
        departments.html
        users.html
    static/
      css/
      js/
  migrations/
  docs/
    系统需求与设计.md
  config.py
  wsgi.py
  .env
  requirements.txt
  README.md
```

## 5. 角色与权限
- 角色：
  - `system_admin`（系统管理员）：全局管理权限；部门增删改查、会员管理、系统配置
  - `president`（会长）：全局管理权限；部门与会员的增删改查（不涉及系统配置）
  - `vice_president`（副会长）：全局管理权限；部门与会员的增删改查
  - `minister`（部长）：本部门管理权限；管理本部门成员与资料，不可新增/删除部门，不可操作其他部门
  - `member`（成员）：仅维护个人资料
- 鉴权策略：
  - 登录后签发访问令牌（Access Token）写入 httpOnly Cookie `access_token_cookie`
  - 启用 CSRF（`Flask-JWT-Extended` Cookie 模式内置支持），表单提交携带 CSRF token
  - 管理端路由校验：`role in {system_admin, president, vice_president}`
  - 部长端路由校验：`role == minister` 且仅可操作 `department_id == current_user.department_id`

## 6. 数据库设计
### 6.1 实体与关系
- 用户（User）：保存注册信息与登录凭据，关联一个部门
- 部门（Department）：名称唯一，供会员选择

关系：`User.department_id -> Department.id`（多对一）

### 6.2 字段定义
- User
  - `id` BIGINT PK
  - `student_id` VARCHAR(32) 学号（唯一）
  - `name` VARCHAR(64) 姓名
  - `class_name` VARCHAR(64) 班级
  - `gender` ENUM('男','女','其他')
  - `grade` VARCHAR(16) 年级（如 2022）
  - `phone` VARCHAR(32) 手机号（规范化存储，支持国际区号）
  - `email` VARCHAR(128) 邮箱
  - `password_hash` VARCHAR(128)
  - `role` ENUM('system_admin','president','vice_president','minister','member') DEFAULT 'member'
  - `registration_status` ENUM('pending','approved','rejected') NOT NULL DEFAULT 'pending'
  - `registration_reason` VARCHAR(255) 可选（审核/驳回理由）
  - `department_id` BIGINT FK -> Department.id
  - `is_active` TINYINT(1) DEFAULT 1
  - `created_at` DATETIME
  - `updated_at` DATETIME
- Department
  - `id` BIGINT PK
  - `name` VARCHAR(64) 唯一
  - `description` VARCHAR(255) 可选
  - `created_at` DATETIME
  - `updated_at` DATETIME

### 6.3 建表 SQL（DDL）
```sql
CREATE TABLE department (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(64) NOT NULL UNIQUE,
  description VARCHAR(255),
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE user (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  student_id VARCHAR(32) NOT NULL UNIQUE,
  name VARCHAR(64) NOT NULL,
  class_name VARCHAR(64) NOT NULL,
  gender ENUM('男','女','其他') NOT NULL,
  grade VARCHAR(16) NOT NULL,
  phone VARCHAR(32),
  email VARCHAR(128),
  password_hash VARCHAR(128) NOT NULL,
  role ENUM('system_admin','president','vice_president','minister','member') NOT NULL DEFAULT 'member',
  registration_status ENUM('pending','approved','rejected') NOT NULL DEFAULT 'pending',
  registration_reason VARCHAR(255),
  department_id BIGINT,
  is_active TINYINT(1) NOT NULL DEFAULT 1,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL,
  CONSTRAINT fk_user_department FOREIGN KEY (department_id)
    REFERENCES department(id) ON UPDATE CASCADE ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 6.4 考试与成绩表设计
- Exam（考试）：可选关联部门；用于记录考试信息与时间
- ExamResult（考试成绩）：记录用户在某次考试的分数与是否通过

建表 SQL（DDL）：
```sql
CREATE TABLE exam (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(128) NOT NULL,
  description VARCHAR(255),
  department_id BIGINT, -- NULL 表示全协会考试
  exam_date DATE NOT NULL,
  pass_threshold DECIMAL(5,2), -- 及格线，可选，如 60.00
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL,
  CONSTRAINT fk_exam_department FOREIGN KEY (department_id)
    REFERENCES department(id) ON UPDATE CASCADE ON DELETE SET NULL,
  INDEX idx_exam_date (exam_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE exam_result (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  exam_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  score DECIMAL(6,2) NOT NULL,
  passed TINYINT(1) NOT NULL,
  remark VARCHAR(255),
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL,
  CONSTRAINT fk_result_exam FOREIGN KEY (exam_id)
    REFERENCES exam(id) ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT fk_result_user FOREIGN KEY (user_id)
    REFERENCES user(id) ON UPDATE CASCADE ON DELETE CASCADE,
  UNIQUE KEY uniq_exam_user (exam_id, user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 7. 页面与路由设计
（前后端不分离，表单 + 服务端渲染；JWT 用于后端鉴权，采用 Cookie 模式）

### 7.1 认证与账号
- `GET /login`：登录页
- `POST /login`：表单登录；成功后发放 JWT，写入 Cookie
- `POST /logout`：清除 Cookie
- `GET /register`：注册页（字段：班级、姓名、学号、性别、年级、密码、部门）
- `POST /register`：提交注册；创建用户（默认 `member`）

### 7.1.1 注册审核流
- 默认状态：`pending`
- 管理端：
  - `GET /admin/registrations`：待审列表
  - `POST /admin/registrations/{user_id}/approve`：通过；记录 `registration_audit` 并将用户状态改为 `approved`
  - `POST /admin/registrations/{user_id}/reject`：驳回；记录理由，状态为 `rejected`
- 通知：通过/驳回后发送站内消息或邮件（见通知配置）

### 7.2 个人中心
- `GET /me`：个人资料页
- `POST /me`：更新个人资料（除学号外，可编辑）

### 7.2.1 资料变更申请
- 成员端：
  - `GET /me/change`：提交变更表单（允许修改：班级、姓名、性别、年级、手机号、邮箱、部门可选）
  - `POST /me/change`：创建 `user_profile_history` 记录，状态 `pending`
- 审批端：
  - 管理端或部长端 `GET /admin/profile-changes` / `GET /leader/profile-changes`：变更队列
  - `POST /.../profile-changes/{id}/approve`：批准并应用变更到 `user` 表，记录历史为 `approved`
  - `POST /.../profile-changes/{id}/reject`：驳回并记录理由，历史为 `rejected`
- 权限：部长端仅可审批本部门成员的变更

### 7.3 部门管理（管理端：系统管理员/会长/副会长）
- `GET /admin/departments`：部门列表页
- `POST /admin/departments`：新增部门（名称唯一；仅管理端）
- `POST /admin/departments/{id}/delete`：删除部门（若有用户关联则置空；仅管理端）
- `POST /admin/departments/{id}`：编辑部门（可选）

### 7.4 会员管理（管理端：系统管理员/会长/副会长）
- `GET /admin/users`：会员列表页（按部门、年级筛选）
- `POST /admin/users/{id}/disable`：禁用/启用会员
- `GET /admin`：管理端仪表盘

### 7.5 部长端（仅本部门）
- `GET /leader/department`：本部门信息页（查看/编辑简介）
- `GET /leader/users`：本部门成员列表
- `POST /leader/users/{id}/disable`：禁用/启用本部门成员

### 7.6 考试与成绩
- 管理端（系统管理员/会长/副会长）：
  - `GET /admin/exams`：考试列表页（可按部门筛选）
  - `POST /admin/exams`：新增考试（标题、日期、及格线、是否关联某部门）
  - `POST /admin/exams/{id}`：编辑考试
  - `POST /admin/exams/{id}/delete`：删除考试（级联删除成绩）
  - `GET /admin/exams/{id}/results`：该考试成绩列表
  - `POST /admin/exams/{id}/results`：新增或更新单个成员成绩（分数、备注）
  - `POST /admin/exams/{id}/results/import`：批量导入 CSV（含 `student_id, score, remark`）
  - `GET /admin/exams/{id}/results/export`：导出 CSV/Excel
- 部长端（仅本部门）：
  - `GET /leader/exams`：本部门考试列表
  - `POST /leader/exams`：为本部门新增考试（department_id 固定为部长本部门）
  - `POST /leader/exams/{id}`：编辑本部门考试
  - `GET /leader/exams/{id}/results`：成绩列表（仅本部门成员）
  - `POST /leader/exams/{id}/results`：维护本部门成员成绩
- 成员端：
- 成员端：
  - `GET /exams`：查看全协会与本部门即将到来的考试
  - `GET /my/results`：查看个人历次考试成绩

### 7.8 积分与等级
- 规则：
  - 考试成绩转积分：示例规则 `points = floor(score)`；实际规则可在配置中心设定加权公式
  - 活动参与积分：活动完成后按固定分值入账
- 路由：
  - `GET /admin/points`：积分管理面板（查看流水、修正、批量操作）
  - `POST /admin/points/adjust`：为指定用户增减积分（记录到流水）
  - `GET /levels`：查看等级与阈值
  - `GET /my/points`：成员查看个人积分与等级（按总积分计算等级：总积分≥某等级阈值即获得该等级）
- 决策：积分变动全部写入 `points_ledger`；等级计算可实时或每日批处理

### 7.7 会员导入与导出
- 管理端（系统管理员/会长/副会长）：
  - `GET /admin/users/export`：导出会员信息（筛选：部门/年级/是否启用；格式：CSV/Excel）
  - `POST /admin/users/import`：导入会员信息（仅 CSV/Excel）。支持按 `student_id` 进行新增或更新（Upsert）。
- 部长端（仅本部门）：
  - `GET /leader/users/export`：导出本部门会员信息（可按年级筛选）
  - `POST /leader/users/import`：导入本部门会员信息（导入数据的 `department` 固定为部长所在部门）
- 导入文件字段规范（CSV，UTF-8）：
  - 必填：`student_id,name,class_name,gender,grade`
  - 可选：`department,is_active`
  - `gender` 取值：`男/女/其他`；`grade` 示例：`2022`
  - `department` 为部门名称；若为空则置空；若名称不存在则报错并跳过该行
- 导入行为：
  - 主键匹配：以 `student_id` 作为唯一键；不存在则新建，存在则更新对应字段（不覆盖密码）
  - 部门限制：部长端导入时强制使用其本部门；管理端按文件列 `department` 映射
  - 行级结果：返回导入报告（成功条数、更新条数、错误条数、错误明细）
- 导出内容字段：`student_id,name,class_name,gender,grade,department,is_active,created_at`

## 8. 鉴权与安全
- JWT 存储于 httpOnly Cookie：`access_token_cookie`
- Cookie 设置：`SameSite=Lax`；开发环境 `Secure=False`，生产 `Secure=True`
- 启用 CSRF：表单含隐藏字段；后端校验 CSRF token
- 密码：`bcrypt` 哈希；禁止明文存储
- 输入校验：后端再校验（避免绕过前端）
- 速率限制与登录失败计数（可选，后续增加）
 - 成绩导入：对文件类型和内容校验；仅允许指定角色使用；对不存在的 `student_id` 给出错误报告
 - 会员导入导出：限制文件类型（CSV/Excel）、大小（如 ≤5MB）；校验必填字段与取值范围；导出使用只读查询并按角色过滤范围
- 审核与历史：所有审批写入审计表；关键变更记录操作人与时间；支持导出审计日志
- 通知：
  - 邮件（SMTP）与站内通知；失败重试与退避策略
  - 事件触发：注册审批、资料变更审批、积分调整

## 9. 验证与错误处理
- 表单级错误：返回模板并展示错误消息
- 统一错误页：`400/401/403/404/500`
- 日志：记录登录失败、管理操作、异常栈

## 10. 典型流程
1) 注册：填写表单 -> 校验 -> 写入用户表（默认 member）
2) 登录：学号 + 密码 -> 校验 -> 签发 JWT 到 Cookie
3) 访问受保护页：读取 Cookie -> 校验 JWT 与角色 -> 放行或 403
4) 管理部门：系统管理员/会长/副会长在页面增删改 -> 影响 Department 表；删除时置空用户的 `department_id`；部长仅可编辑本部门信息与成员状态
5) 考试与成绩：创建考试（可选关联部门） -> 录入或导入成绩 -> 成员查看个人成绩与通过状态
6) 注册审核：成员注册为 `pending` -> 管理端审核 -> 通知成员结果
7) 资料变更：成员提交变更 -> 部长/管理端审批 -> 应用并写入历史
8) 积分与等级：考试或活动入账 -> 计算总积分 -> 确定等级与荣誉
9) 配置中心：启动无法连接数据库 -> 跳转 `/setup` -> 成功后加载应用
6) 会员导入导出：上传 CSV -> 校验并 Upsert -> 返回导入报告；导出按筛选条件生成文件

## 11. 开发里程碑（建议）
- 里程碑 1：项目骨架、配置、数据库迁移、基础模板
- 里程碑 2：注册/登录/JWT/个人资料
- 里程碑 3：部门管理（增删改查）
- 里程碑 4：会员列表与筛选、禁用/启用
- 里程碑 5：安全加固、日志、导出（CSV/Excel，可选）

## 12. 后续可选功能
- 导出会员名单（按部门/年级）
- 审核流：注册需管理员审核通过
- 多部门支持（若业务需要多选）
- 活动报名模块与出勤统计

## 13. 注意与约定
- 会员只能关联一个部门（当前版本约定）
- 学号唯一且作为登录名
- 删除部门时不删除用户，用户 `department_id` 置空
- 所有敏感操作需相应角色权限（管理端或部长端）
- 考试成绩唯一约束：同一 `exam_id` 与 `user_id` 只能有一条记录
- 成绩范围建议 0~100；`passed` 可按 `score >= pass_threshold` 自动计算
 - 手机号与邮箱校验：手机号支持国际格式；邮箱需 RFC 基本格式校验
 - 注册审核与资料变更均需保留审计记录，不可删除，仅可追加

---
如需调整字段或流程，请标注在本文档并迭代。
### 6.5 审核与历史表设计
- RegistrationAudit（注册审核记录）：记录每次审批的操作者与理由
- UserProfileHistory（资料变更历史）：保留变更前后字段及审批信息

建表 SQL（DDL）：
```sql
CREATE TABLE registration_audit (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  action ENUM('approve','reject') NOT NULL,
  reason VARCHAR(255),
  operator_id BIGINT NOT NULL, -- 审批人
  created_at DATETIME NOT NULL,
  CONSTRAINT fk_regaudit_user FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
  CONSTRAINT fk_regaudit_operator FOREIGN KEY (operator_id) REFERENCES user(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE user_profile_history (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  changes JSON NOT NULL, -- {field: {old: ..., new: ...}}
  status ENUM('pending','approved','rejected') NOT NULL,
  approver_id BIGINT,
  reason VARCHAR(255),
  created_at DATETIME NOT NULL,
  decided_at DATETIME,
  CONSTRAINT fk_profilehist_user FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
  CONSTRAINT fk_profilehist_approver FOREIGN KEY (approver_id) REFERENCES user(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 6.6 积分与等级表设计
- Level（等级）：配置积分阈值与称号
- PointsLedger（积分流水）：记录积分来源与变动

建表 SQL（DDL）：
```sql
CREATE TABLE level (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(64) NOT NULL UNIQUE,
  threshold_points INT NOT NULL, -- 达到即晋级
  description VARCHAR(255),
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE points_ledger (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  source_type ENUM('exam','activity','manual') NOT NULL,
  source_id BIGINT,
  points INT NOT NULL,
  remark VARCHAR(255),
  created_at DATETIME NOT NULL,
  CONSTRAINT fk_points_user FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
  INDEX idx_points_user_created (user_id, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```
- 导出内容字段：`student_id,name,class_name,gender,grade,department,is_active,created_at`
  - 额外可选列：`phone,email,registration_status`
## 9. 配置中心
- 目的：集中管理系统配置（数据库连接、邮件服务器、积分规则等）
- 存储：
  - 优先使用 `.env` 写入基础项（`DATABASE_URL`、`JWT_SECRET_KEY`、`SECRET_KEY`）
  - 业务配置（如积分公式、SMTP 设置）存入 `system_settings` 表（后续迁移时建立）
- 启动逻辑：
  - 应用启动时尝试连接数据库；若失败则跳转到 `GET /setup`
  - `GET /setup`：配置页面（数据库地址、用户名、密码、库名、端口）
  - `POST /setup`：校验并保存；写入 `.env` 或临时配置文件；引导重启或重新初始化连接
- 权限与安全：
  - 首次安装允许匿名访问 `/setup`，完成后仅 `system_admin` 可访问
  - 对敏感信息（密码）进行最小暴露与写入权限控制
  - 配置页面启用 CSRF、速率限制与基础 CAPTCHA（可选）
